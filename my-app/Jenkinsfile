pipeline {
    agent any

    environment {
        NODEJS_HOME = tool 'NodeJS-18'
        PATH = "${NODEJS_HOME}/bin:${env.PATH}"
    }
    
    stages {
        stage('Checkout') {
            steps {
                // Ensure we're in the correct directory
                sh 'pwd'
                sh 'ls -la'
            }
        }

        stage('Prepare Project Structure') {
            steps {
                script {
                    // Create package.json if not exists
                    sh '''
                    if [ ! -f package.json ]; then
                        echo '{
                            "name": "react-jest-project",
                            "version": "1.0.0",
                            "description": "React project with Jest testing",
                            "main": "index.js",
                            "scripts": {
                                "test": "jest",
                                "test:ci": "jest --ci --reporters=default --reporters=jest-junit",
                                "build": "echo \\"No build script specified\\"",
                                "start": "echo \\"No start script specified\\""
                            },
                            "keywords": ["react", "jest", "testing"],
                            "author": "",
                            "license": "ISC",
                            "devDependencies": {},
                            "dependencies": {}
                        }' > package.json
                    fi
                    '''
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                script {
                    sh '''
                    npm cache clean --force
                    npm install --save-dev \
                        jest \
                        @testing-library/react \
                        @testing-library/jest-dom \
                        @testing-library/user-event \
                        jest-environment-jsdom \
                        babel-jest \
                        @babel/preset-env \
                        @babel/preset-react \
                        jest-junit \
                        identity-obj-proxy
                    
                    npm install react react-dom
                    '''
                }
            }
        }

        stage('Create Test Configuration') {
            steps {
                script {
                    // Create Jest configuration
                    writeFile file: 'jest.config.js', text: '''
module.exports = {
    testEnvironment: 'jsdom',
    setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
    moduleNameMapper: {
        '\\\\.(css|less|scss|sass)$': 'identity-obj-proxy',
        '\\\\.(jpg|jpeg|png|gif|webp|svg)$': '<rootDir>/__mocks__/fileMock.js'
    },
    transform: {
        '^.+\\\\.(js|jsx|ts|tsx)$': 'babel-jest'
    },
    collectCoverage: true,
    coverageDirectory: 'coverage',
    coverageReporters: ['text', 'lcov', 'cobertura'],
    reporters: [
        'default',
        ['jest-junit', { 
            outputDirectory: 'test-results',
            outputName: 'junit.xml' 
        }]
    ]
};
                    '''

                    // Create Babel configuration
                    writeFile file: '.babelrc', text: '''
{
    "presets": [
        "@babel/preset-env",
        ["@babel/preset-react", {"runtime": "automatic"}]
    ]
}
                    '''

                    // Create Jest setup file
                    writeFile file: 'jest.setup.js', text: '''
import '@testing-library/jest-dom';
                    '''

                    // Ensure mocks directory exists
                    sh 'mkdir -p __mocks__'

                    // Create file mock
                    writeFile file: '__mocks__/fileMock.js', text: '''
module.exports = 'test-file-stub';
                    '''
                }
            }
        }

        stage('Run Jest Tests') {
            steps {
                script {
                    // Run Jest tests
                    sh '''
                    mkdir -p test-results
                    npm test -- \
                        --config=jest.config.js \
                        --coverage \
                        --coverageReporters=text \
                        --coverageReporters=lcov \
                        --coverageReporters=cobertura \
                        --reporters=default \
                        --reporters=jest-junit
                    '''
                }
            }
            post {
                always {
                    // Publish test results
                    junit allowEmptyResults: true, testResults: 'test-results/junit.xml'
                    
                    // Publish coverage reports
                    cobertura coberturaReportFile: 'coverage/cobertura-coverage.xml'
                    
                    // Publish HTML coverage report
                    publishHTML(target: [
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'coverage',
                        reportFiles: 'index.html',
                        reportName: 'Jest Coverage Report'
                    ])
                }
            }
        }

        stage('Build') {
            steps {
                script {
                    sh 'npm run build || echo "No build script specified"'
                }
            }
        }
    }

    post {
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed. Check logs and test reports.'
            
            // Optional: Send notification
            mail to: 'your-email@example.com',
                 subject: "Pipeline Failed: ${currentBuild.fullDisplayName}",
                 body: "Something is wrong with the build. Check console output at ${env.BUILD_URL}"
        }
        always {
            // Clean up workspace
            cleanWs()
        }
    }
}