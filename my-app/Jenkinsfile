pipeline {
    agent any

    environment {
        NODEJS_HOME = tool 'NodeJS-18'
        PATH = "${NODEJS_HOME}/bin:${env.PATH}"
        NODE_OPTIONS = "--max_old_space_size=4096" // Prevents out-of-memory issues
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo "Checking out code..."
                sh 'pwd && ls -la'
            }
        }

        stage('Verify Node & npm') {
            steps {
                sh 'node -v && npm -v'
            }
        }

        stage('Install Dependencies') {
            steps {
                script {
                    echo "Installing dependencies..."
                    sh '''
                    set -e
                    npm cache clean --force
                    npm install
                    '''
                }
            }
        }

        stage('Create Test Configuration') {
            steps {
                script {
                    echo "Creating Jest and Babel configuration files..."
                    
                    writeFile file: 'jest.config.js', text: '''
module.exports = {
    testEnvironment: 'jsdom',
    setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
    moduleNameMapper: {
        '\\.(css|less|scss|sass)$': 'identity-obj-proxy',
        '\\.(jpg|jpeg|png|gif|webp|svg)$': '<rootDir>/__mocks__/fileMock.js'
    },
    transform: {
        '^.+\\.(js|jsx|ts|tsx)$': 'babel-jest'
    },
    collectCoverage: true,
    coverageDirectory: 'coverage',
    coverageReporters: ['text', 'lcov', 'cobertura'],
    reporters: [
        'default',
        ['jest-junit', { 
            outputDirectory: 'test-results',
            outputName: 'junit.xml' 
        }]
    ]
};
                    '''

                    writeFile file: '.babelrc', text: '''
{
    "presets": [
        "@babel/preset-env",
        ["@babel/preset-react", {"runtime": "automatic"}]
    ]
}
                    '''

                    writeFile file: 'jest.setup.js', text: '''
import '@testing-library/jest-dom';
                    '''

                    sh 'mkdir -p __mocks__'
                    writeFile file: '__mocks__/fileMock.js', text: '''
module.exports = 'test-file-stub';
                    '''
                }
            }
        }

        stage('Run Jest Tests') {
            steps {
                script {
                    echo "Running Jest tests..."
                    sh '''
                    set -e
                    mkdir -p test-results
                    npm test -- \
                        --config=jest.config.js \
                        --coverage \
                        --coverageReporters=text \
                        --coverageReporters=lcov \
                        --coverageReporters=cobertura \
                        --reporters=default \
                        --reporters=jest-junit
                    '''
                }
            }
            post {
                always {
                    echo "Publishing test results..."
                    junit allowEmptyResults: true, testResults: 'test-results/junit.xml'
                    
                    echo "Publishing coverage reports..."
                    cobertura coberturaReportFile: 'coverage/cobertura-coverage.xml'
                    
                    publishHTML(target: [
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'coverage',
                        reportFiles: 'index.html',
                        reportName: 'Jest Coverage Report'
                    ])
                }
            }
        }

        stage('Build') {
            steps {
                script {
                    echo "Running build step..."
                    sh 'npm run build || echo "No build script specified"'
                }
            }
        }
    }

    post {
        success {
            echo '✅ Pipeline completed successfully!'
        }
        failure {
            echo '❌ Pipeline failed. Check logs and test reports.'
            mail to: 'your-email@example.com',
                 subject: "Pipeline Failed: ${currentBuild.fullDisplayName}",
                 body: "Something is wrong with the build. Check console output at ${env.BUILD_URL}"
        }
        always {
            echo "Cleaning up workspace (except source files)..."
            sh 'rm -rf node_modules coverage test-results || true'
        }
    }
}
